<html>
<head>
    <title>JSON Custom Search API Example</title>
    <script src="js/FileSaver.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
<!--    <script src="js/d3-fetch.js"></script>-->
</head>
<body>
    <div id="content"></div>
    <script>
        const corsUrl = 'https://cors-anywhere.herokuapp.com/';
        const apiKey = 'AIzaSyCrAzt_jdZVJk4nyAj0y-DhQ8gpEqteV-A';
        const cx = '000123793121465220160:xw4tm7gc7xm';             // *.mall.industry.siemens
        const query = '3SB3400-1RC';

        let cxList = [{cx: '000123793121465220160:xw4tm7gc7xm', abbr: 'SIE'},       // *.mall.industry.siemens
                      {cx: '', abbr: ''}
                      ];
        
        const csvFileName = 'csv/queryList.csv';

        function createQueryListFromCSV(fileName) {
            d3.dsv(",", fileName, function(d) {
                return {
                    order: d.Order,
                    vendor: d.Vendor
                };
            }).then(function(data) {
                console.log(data);
            });
        }
        
        createQueryListFromCSV(csvFileName);
        
        let queryList = [{order: '3SB3400-1RC', cxAbbr: 'SIE', imgUrl: ''},
                         {order: '3RH1921-1HA22', cxAbbr: 'SIE', imgUrl: ''}
                         ];

        function gSearch(queryList) {
        
        }
        
        function googleSearch(apiKey, cx, query) {
            const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${query}&callback=hndlr`;
            let script = document.createElement('script');
            script.id = "searchScript";
            script.src = searchUrl;
            document.body.appendChild(script);
        }

        function hndlr(response) {
            const searchUrl = response.items[1].link;
            const searchClass = ".pictureArea";
    
            getElement(searchUrl, searchClass, function (element) {
                // document.getElementById("content").innerHTML += "<br>" + element.innerHTML;
                // document.getElementById("content").innerHTML += "<br>" + document.querySelector('.productPicture').src;
    
                let newDiv = document.createElement("div");
                newDiv.appendChild(element);
    
                const imgUrl = corsUrl + newDiv.querySelector('.productPicture').src;
                startDownload(imgUrl);
            });
        }
        
        function getElement(url, selector, c) {
            request(new XMLHttpRequest());
            
            function request(xhr) {
                xhr.open('GET', corsUrl + url, true);
                xhr.send();
                xhr.onreadystatechange = function() {
                    let html;
                    if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                        html = document.createElement('div');
                        html.innerHTML = xhr.responseText;
                        c(html.querySelector(selector));
                    }
                }
            }
        }
        
        function startDownload(imageURL) {
            let downloadedImg = new Image;
            downloadedImg.crossOrigin = "Anonymous";
            downloadedImg.addEventListener("load", imageReceived, false);
            downloadedImg.src = imageURL;
        }
        
        function imageReceived() {
            let canvas = document.createElement("canvas");
            let context = canvas.getContext("2d");
            
            canvas.width = this.width;
            canvas.height = this.height;
            
            context.drawImage(this, 0, 0);
            
            try {
                //localStorage.setItem("saved-image-example", canvas.toDataURL("image/png"));
                //var pic = localStorage.getItem("saved-image-example");
                
                //var pic64 = canvas.toDataURL('image/jpeg', 1.0);
                
                const link = document.createElement("a");
                link.download = "image_1.jpg";
                link.href = canvas.toDataURL('image/jpeg', 1.0);
                link.click();
                link.remove();
                
            }
            catch(err) {
                console.log("Error: " + err);
            }
        }

        if (document.getElementById("searchScript")) {
            document.getElementById("searchScript").remove();
        }

        googleSearch(apiKey, cx, query);
    </script>
</body>
</html>
